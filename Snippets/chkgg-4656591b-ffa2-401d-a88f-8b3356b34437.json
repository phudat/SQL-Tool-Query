{
  "id": "4656591b-ffa2-401d-a88f-8b3356b34437",
  "prefix": "chkgg",
  "description": "Check gỉảm giá",
  "body": "DECLARE @DocEntry INT = $CURSOR$;\n\nSELECT\n    ItemCode\n  , LineNum = ROW_NUMBER() OVER (ORDER BY ItemCode)\n  , LineNum LineSO\n  , phantram = R.U_DisOther * 100 * 1.0 / (U_Price * Quantity)\n  , R.U_WhsCod WhsCod\nINTO\n    #tmpDiscount\nFROM\n    dbo.RDR1 R (NOLOCK)\nWHERE\n    R.DocEntry = @DocEntry\n    AND R.DiscPrcnt > 0\n    AND ItemCode <> '00001891';\n\nSELECT O.DocEntry, O.DocStatus, O.DocDate, O.U_ExDate, O.Type_ReturnSO, O.PickStatus, O.U_ShpCod FROM FRT_POS.dbo.ORDR AS O WITH (NOLOCK) WHERE O.DocEntry = @DocEntry\nSELECT R.ItemCode, R.U_IMei, R.U_WhsCod, R.U_Price, R.Quantity, R.U_TaxAmo, R.U_TMoney, R.DiscPrcnt, R.U_DisOther, R.U_ReaCode, * FROM FRT_POS.dbo.RDR1 AS R WITH (NOLOCK) WHERE R.DocEntry = @DocEntry\nSELECT * FROM #tmpDiscount (NOLOCK)\n\nDECLARE\n        @StepDiscount INT = 1\n      , @CountDiscount INT = 0\n      , @ItemCodeDiscount VARCHAR(20)= ''\n      , @PercentDiscount NUMERIC= 0.0\n      , @WhsCodDiscount VARCHAR(8)= '';\n\nDECLARE\n        @SendedUser VARCHAR(100)\n      , @LineSO INT = 0;\n\nSELECT\n    @CountDiscount = COUNT(*)\nFROM\n    #tmpDiscount;\n\nCREATE TABLE #tmpDiscountUsers\n    (\n        JobTitle VARCHAR(10)\n      , ApprovalUsers VARCHAR(1000)\n    );\n\nWHILE @StepDiscount <= @CountDiscount\n      BEGIN\n            SELECT\n                @ItemCodeDiscount = ItemCode\n              , @PercentDiscount = phantram\n              , @WhsCodDiscount = WhsCod\n              , @LineSO = LineSO\n            FROM\n                #tmpDiscount\n            WHERE\n                LineNum = @StepDiscount;\n\n            INSERT  INTO #tmpDiscountUsers\n                (\n                     JobTitle\n                   , ApprovalUsers\n                )\n            EXEC dbo.sp_COMMOND_CheckRoles \n\t\t\t\t@ItemCode = @ItemCodeDiscount, -- nvarchar(100)\n                @Price = NULL, -- numeric\n                @Percent = @PercentDiscount, -- numeric\n                @Date = NULL, -- datetime\n                @Type = 1, -- int\n                @Whscode = @WhsCodDiscount, -- varchar(20)\n                @Imei = '', -- varchar(50)\n                @GRPONum = @DocEntry; -- varchar(100\n\n\t\t\tSELECT @ItemCodeDiscount ItemCode, @PercentDiscount [Percent]\n\n\t\t\tSET @StepDiscount += 1\n      END;\n\nSELECT * FROM #tmpDiscountUsers\n\nDROP TABLE #tmpDiscount, #tmpDiscountUsers"
}