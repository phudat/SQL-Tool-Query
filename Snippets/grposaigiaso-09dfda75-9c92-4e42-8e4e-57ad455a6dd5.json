{
  "id": "09dfda75-9c92-4e42-8e4e-57ad455a6dd5",
  "prefix": "grposaigiaso",
  "description": "Update GRPO sai giá với SO",
  "body": "DECLARE \n\t  @OPDNDocEntry INT = $CURSOR$\n\t, @Update\t\tBIT\t= 0\n\nIF @Update = 0\n\tBEGIN\t\n\t\tSELECT\n\t\t\t  O.DocEntry\n\t\t\t, O.U_NumSO\n\t\t\t, D.DocEntry\n\t\t\t, P.ItemCode\n\t\t\t, P.U_IMei\n\t\t\t, P.Price\n\t\t\t, R.DocEntry\n\t\t\t, R.ItemCode\n\t\t\t, R.U_IMei\n\t\t\t, R.U_Price\n\t\tFROM\n\t\t\tdbo.PDN1 P (NOLOCK)\n\t\t\t\tINNER JOIN dbo.OPDN O (NOLOCK)\n\t\t\t\t\tON P.DocEntry = O.DocEntry\n\t\t\t\tINNER JOIN dbo.ORDR D (NOLOCK)\n\t\t\t\t\tON O.U_NumSO = D.DocEntry\n\t\t\t\tINNER JOIN dbo.RDR1 R (NOLOCK)\n\t\t\t\t\tON D.DocEntry = R.DocEntry\n\t\t\t\t\t\tAND P.U_IMei = R.U_IMei\n\t\t\t\t\t\tAND P.ItemCode = R.ItemCode\n\t\tWHERE\n\t\t\tO.DocEntry = @OPDNDocEntry\n\t\t\tAND R.U_Price <> P.Price\n\n\t\tSELECT\n\t\t\tL.*\n\t\t\t, O.DocEntry\n\t\t\t, P.ItemCode\n\t\t\t, P.U_IMei\n\t\t\t, P.Price\n\t\t\t, R.ItemCode\n\t\t\t, R.U_IMei\n\t\t\t, R.U_Price\n\t\tFROM\n\t\t\tdbo.OPDN O (NOLOCK)\n\t\t\t\tINNER JOIN dbo.FRT_POS_OIVL L (NOLOCK)\n\t\t\t\t\tON O.DocEntry = L.Docentry\n\t\t\t\t\t\tAND L.TypeGD = 2\n\t\t\t\tINNER JOIN dbo.PDN1 P (NOLOCK)\n\t\t\t\t\tON O.DocEntry = P.DocEntry\n\t\t\t\t\t\tAND L.EMEI = P.U_IMei\n\t\t\t\t\t\tAND L.ItemCode = P.ItemCode\n\t\t\t\tINNER JOIN dbo.ORDR D (NOLOCK)\n\t\t\t\t\tON O.U_NumSO = D.DocEntry\n\t\t\t\tINNER JOIN dbo.RDR1 R (NOLOCK)\n\t\t\t\t\tON D.DocEntry = R.DocEntry\n\t\tWHERE \n\t\t\tO.DocEntry = @OPDNDocEntry\n\t\t\tAND L.OpenStockPrice <> R.U_Price\n\n\t\tSELECT\n\t\t\tL.*\n\t\t\t, O.DocEntry\n\t\t\t, P.ItemCode\n\t\t\t, P.U_IMei\n\t\t\t, P.Price\n\t\t\t, R.ItemCode\n\t\t\t, R.U_IMei\n\t\t\t, R.U_Price\n\t\tFROM\n\t\t\tdbo.OPDN O (NOLOCK)\n\t\t\t\tINNER JOIN dbo.FRT_POS_OIVQ L (NOLOCK)\n\t\t\t\t\tON O.DocEntry = L.Docentry\n\t\t\t\t\t\tAND L.TypeGD = 2\n\t\t\t\tINNER JOIN dbo.PDN1 P (NOLOCK)\n\t\t\t\t\tON O.DocEntry = P.DocEntry\n\t\t\t\t\t\tAND L.EMEI = P.U_IMei\n\t\t\t\t\t\tAND L.ItemCode = P.ItemCode\n\t\t\t\tINNER JOIN dbo.ORDR D (NOLOCK)\n\t\t\t\t\tON O.U_NumSO = D.DocEntry\n\t\t\t\tINNER JOIN dbo.RDR1 R (NOLOCK)\n\t\t\t\t\tON D.DocEntry = R.DocEntry\n\t\tWHERE \n\t\t\tO.DocEntry = @OPDNDocEntry\n\t\t\tAND L.OpenStockPrice <> R.U_Price\n\tEND\nIF @Update = 1\n\tBEGIN\t\n\t\tUPDATE\n\t\t\tP\n\t\tSET\t\n\t\t\tP.Price = R.U_Price\n\t\tFROM\n\t\t\tdbo.PDN1 P (NOLOCK)\n\t\t\t\tINNER JOIN dbo.OPDN O (NOLOCK)\n\t\t\t\t\tON P.DocEntry = O.DocEntry\n\t\t\t\tINNER JOIN dbo.ORDR D (NOLOCK)\n\t\t\t\t\tON O.U_NumSO = D.DocEntry\n\t\t\t\tINNER JOIN dbo.RDR1 R (NOLOCK)\n\t\t\t\t\tON D.DocEntry = R.DocEntry\n\t\t\t\t\t\tAND P.U_IMei = R.U_IMei\n\t\t\t\t\t\tAND P.ItemCode = R.ItemCode\n\t\tWHERE\n\t\t\tO.DocEntry = @OPDNDocEntry\n\t\t\tAND R.U_Price <> P.Price\n\n\t\tUPDATE\n\t\t\tL\n\t\tSET\n\t\t\tL.OpenStockPrice = R.U_Price\n\t\tFROM\n\t\t\tdbo.OPDN O (NOLOCK)\n\t\t\t\tINNER JOIN dbo.FRT_POS_OIVL L (NOLOCK)\n\t\t\t\t\tON O.DocEntry = L.Docentry\n\t\t\t\t\t\tAND L.TypeGD = 2\n\t\t\t\tINNER JOIN dbo.PDN1 P (NOLOCK)\n\t\t\t\t\tON O.DocEntry = P.DocEntry\n\t\t\t\t\t\tAND L.EMEI = P.U_IMei\n\t\t\t\t\t\tAND L.ItemCode = P.ItemCode\n\t\t\t\tINNER JOIN dbo.ORDR D (NOLOCK)\n\t\t\t\t\tON O.U_NumSO = D.DocEntry\n\t\t\t\tINNER JOIN dbo.RDR1 R (NOLOCK)\n\t\t\t\t\tON D.DocEntry = R.DocEntry\n\t\tWHERE \n\t\t\tO.DocEntry = @OPDNDocEntry\n\t\t\tAND L.OpenStockPrice <> R.U_Price\n\n\t\tUPDATE\n\t\t\tL\n\t\tSET\n\t\t\tL.OpenStockPrice = R.U_Price\n\t\tFROM\n\t\t\tdbo.OPDN O (NOLOCK)\n\t\t\t\tINNER JOIN dbo.FRT_POS_OIVQ L (NOLOCK)\n\t\t\t\t\tON O.DocEntry = L.Docentry\n\t\t\t\t\t\tAND L.TypeGD = 2\n\t\t\t\tINNER JOIN dbo.PDN1 P (NOLOCK)\n\t\t\t\t\tON O.DocEntry = P.DocEntry\n\t\t\t\t\t\tAND L.EMEI = P.U_IMei\n\t\t\t\t\t\tAND L.ItemCode = P.ItemCode\n\t\t\t\tINNER JOIN dbo.ORDR D (NOLOCK)\n\t\t\t\t\tON O.U_NumSO = D.DocEntry\n\t\t\t\tINNER JOIN dbo.RDR1 R (NOLOCK)\n\t\t\t\t\tON D.DocEntry = R.DocEntry\n\t\tWHERE \n\t\t\tO.DocEntry = @OPDNDocEntry\n\t\t\tAND L.OpenStockPrice <> R.U_Price\n\tEND"
}