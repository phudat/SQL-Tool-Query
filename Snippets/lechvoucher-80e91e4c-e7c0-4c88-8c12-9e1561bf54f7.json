{
  "id": "80e91e4c-e7c0-4c88-8c12-9e1561bf54f7",
  "prefix": "lechvoucher",
  "description": "Chạy lệch voucher ALL",
  "body": "SELECT\n    *\nINTO\n    #tmpVoucherCoGia\nFROM\n    dbo.ITEM_VOCH (NOLOCK)\nWHERE\n    U_LoaiVou = 'Y';\n\nSELECT CONVERT(NVARCHAR(500), N'1. Có ' + CONVERT(VARCHAR, COUNT(1)) + N' mã voucher.') Msg INTO #tmpMsg FROM #tmpVoucherCoGia\n\nSELECT\n    ItemcodeVoch\n  , COUNT(*) SL\nINTO\n    #tmpVoucherCount\nFROM\n    dbo.FRT_VOCH_TEMP\nWHERE\n    ItemcodeVoch IN (SELECT U_ItmCod FROM #tmpVoucherCoGia)\nGROUP BY\n    ItemcodeVoch;\n\nSELECT DISTINCT\n    c.ItemcodeVoch\n  , c.SL\nINTO\n    #tmpVoucherHieuLuc\nFROM\n    dbo.[@FPTVOCH] v (NOLOCK)\n\t\tINNER JOIN #tmpVoucherCount c\n\t\t\tON c.ItemcodeVoch = v.U_ItmCod\nWHERE\n    CONVERT(DATE, GETDATE()) BETWEEN CONVERT(DATE, U_StartD) AND CONVERT(DATE, U_EndD)\n    AND U_Status = 'N'\n    AND U_ExBill = 'N'\n    AND U_IssBill = 'N'\n    AND U_IssIn IS NULL\n    AND v.U_BillIn IS NULL;\n\nINSERT INTO #tmpMsg (Msg) \nSELECT CONVERT(NVARCHAR(500), N'2. Có ' + CONVERT(VARCHAR, COUNT(1)) + N' mã voucher còn hiệu lực.') FROM #tmpVoucherHieuLuc\n\nSELECT DISTINCT\n    c.ItemcodeVoch\nINTO\n    #tmpVoucherLineOK\nFROM\n    dbo.[@FPTVOCH] v (NOLOCK)\n\t\tINNER JOIN #tmpVoucherHieuLuc c\n\t\t\tON c.ItemcodeVoch = v.U_ItmCod\nWHERE\n    CONVERT(DATE, GETDATE()) BETWEEN CONVERT(DATE, U_StartD) AND CONVERT(DATE, U_EndD)\n    AND U_Status = 'N'\n    AND U_ExBill = 'N'\n    AND U_IssBill = 'N'\n    AND U_IssIn IS NULL\n    AND c.SL + 1 = v.LineId\n    AND v.U_BillIn IS NULL;\n\nSELECT\n    *\nINTO\n\t#tmpVoucherLech\nFROM\n    #tmpVoucherHieuLuc\nWHERE\n    ItemcodeVoch NOT IN (SELECT * FROM #tmpVoucherLineOK);\n\nINSERT INTO #tmpMsg (Msg) \nSELECT CONVERT(NVARCHAR(500), N'3. Có ' + CONVERT(VARCHAR, COUNT(1)) + N' mã voucher bị lệch line.') FROM #tmpVoucherLech\n\nDECLARE @C_ItemCodeVoch NVARCHAR(50)\n\nDECLARE C_VOUCHER CURSOR SCROLL LOCAL \nFOR \nSELECT ItemcodeVoch FROM #tmpVoucherLech\nOPEN C_VOUCHER\nFETCH FIRST FROM C_VOUCHER INTO @C_ItemCodeVoch\n\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n    \tEXEC dbo.sp_AutoLineVoucher_new @ItemCodeVoucher = @C_ItemCodeVoch\n\n    \tFETCH NEXT FROM C_VOUCHER INTO @C_ItemCodeVoch\n\tEND\n\nCLOSE C_VOUCHER\nDEALLOCATE C_VOUCHER\n\nSELECT * FROM #tmpMsg\n\nDROP TABLE \n\t  #tmpVoucherHieuLuc\n\t, #tmpVoucherCount\n\t, #tmpVoucherCoGia\n\t, #tmpVoucherLineOK\n\t, #tmpVoucherLech\n\t, #tmpMsg;"
}