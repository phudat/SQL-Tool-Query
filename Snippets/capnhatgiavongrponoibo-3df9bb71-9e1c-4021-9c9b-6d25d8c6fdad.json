{
  "id": "3df9bb71-9e1c-4021-9c9b-6d25d8c6fdad",
  "prefix": "capnhatgiavongrponoibo",
  "description": "Cập nhật giá vốn GRPO nội bộ theo SO",
  "body": "DECLARE\n\t  @SODocEntry\tINT = $CURSOR$\n\t, @GRPODocEntry INT = 0\n\t, @IsUpdate\t\tBIT = 0\n\nIF @IsUpdate = 1\n\tBEGIN\n\t    UPDATE\n\t\t\tP\n\t\tSET\n\t\t\tP.Price = O.OpenStockPrice\n\t\tFROM\n\t\t\tdbo.PDN1 P (NOLOCK)\n\t\t\t\tINNER JOIN dbo.FRT_POS_OIVL O (NOLOCK)\n\t\t\t\t\tON P.U_IMei = O.EMEI\n\t\tWHERE\n\t\t\tP.DocEntry = @GRPODocEntry\n\t\t\tAND O.Docentry = @SODocEntry\n\t\t\tAND O.TypeGD = 1\n\t\t\tAND P.Price <> O.OpenStockPrice\n\n\t\tUPDATE\n\t\t    FRT_POS.dbo.PDN1\n\t\tSET\n\t\t      U_TaxAmo = ROUND((Price * U_Quantity) * (U_TaxRate / 100), 0)\n\t\t\t, U_TaxAmL = ROUND((Price * U_Quantity), 0)\n\t\t\t, U_TMoney = ROUND((Price * U_Quantity) * (1 + U_TaxRate / 100), 0)\n\t\tWHERE\n\t\t    DocEntry = @GRPODocEntry\n\n\t\tUPDATE B SET  \n\t\t      U_TMonBi\t = B1.U_TMoney\n\t\t    , U_TMonTx\t = B1.U_TaxAmo\n\t\t    , B.DocTotal = B1.U_TMoney\n\t\t\t, B.U_TMonPr = B1.U_TMoney - B1.U_TaxAmo FROM \n\t\tFRT_POS.dbo.OPDN B WITH (NOLOCK), \n\t\t    (SELECT DocEntry, SUM(ISNULL(U_TMoney, 0)) AS U_TMoney, SUM(ISNULL(U_TaxAmo, 0)) AS U_TaxAmo \n\t\t    \tFROM FRT_POS.dbo.PDN1 WITH (NOLOCK)\n\t\t    \tWHERE DocEntry = @GRPODocEntry\n\t\tGROUP BY DocEntry) B1 WHERE \n\t\t    B.DocEntry = B1.DocEntry\n\n\t\tUPDATE\n\t\t\tR\n\t\tSET\n\t\t\t  R.U_Price = O.OpenStockPrice\n\t\t\t, R.Price = O.OpenStockPrice\n\t\tFROM\n\t\t\tdbo.RDR1 R (NOLOCK)\n\t\t\t\tINNER JOIN dbo.FRT_POS_OIVL O (NOLOCK)\n\t\t\t\t\tON R.U_IMei = O.EMEI\n\t\tWHERE\n\t\t\tR.DocEntry = @SODocEntry\n\t\t\tAND O.Docentry = @SODocEntry\n\t\t\tAND O.TypeGD = 1\n\t\t\tAND R.U_Price <> O.OpenStockPrice\n\n\t\tUPDATE\n\t\t    FRT_POS.dbo.RDR1\n\t\tSET\n\t\t      U_TaxAmo = ROUND((U_Price * Quantity - ISNULL(DiscPrcnt, 0) - ISNULL(U_DisOther, 0)) * (U_TaxRate / 100), 0)\n\t\t\t, U_TaxAmL = ROUND((U_Price * Quantity - ISNULL(DiscPrcnt, 0) - ISNULL(U_DisOther, 0)), 0)\n\t\t\t, U_TMoney = ROUND((U_Price * Quantity - ISNULL(DiscPrcnt, 0) - ISNULL(U_DisOther, 0)) * (1 + U_TaxRate / 100), 0)\n\t\tWHERE\n\t\t    DocEntry = @SODocEntry\n\n\t\tUPDATE B SET  \n\t\t      U_TMonPr\t= B1.U_TMoney - B1.U_TaxAmo\n\t\t    , U_TMonTx\t= B1.U_TaxAmo\n\t\t    , U_TMonBi\t= B1.U_TMoney FROM \n\t\tFRT_POS.dbo.ORDR B WITH (NOLOCK), \n\t\t    (SELECT DocEntry, SUM(ISNULL(U_TMoney, 0)) AS U_TMoney, SUM(ISNULL(U_TaxAmo, 0)) AS U_TaxAmo \n\t\t    \tFROM FRT_POS.dbo.RDR1 WITH (NOLOCK)\n\t\t    \tWHERE DocEntry = @SODocEntry\n\t\tGROUP BY DocEntry) B1 WHERE \n\t\t    B.DocEntry = B1.DocEntry\n\n\tEND\nELSE\n\tBEGIN\n\t    SELECT\n\t\t\t  P.DocEntry\n\t\t\t, P.ItemCode\n\t\t\t, P.Dscription\n\t\t\t, P.U_WhsCod\n\t\t\t, P.U_IMei\n\t\t\t, P.Quantity\n\t\t\t, P.Price\n\t\t\t, '----'\n\t\t\t, O.Docentry\n\t\t\t, O.ItemCode\n\t\t\t, O.EMEI\n\t\t\t, O.Whscode\n\t\t\t, O.Quantity\n\t\t\t, O.OpenStockPrice\n\t\tFROM\n\t\t\tdbo.PDN1 P (NOLOCK)\n\t\t\t\tINNER JOIN dbo.FRT_POS_OIVL O (NOLOCK)\n\t\t\t\t\tON P.U_IMei = O.EMEI\n\t\tWHERE\n\t\t\tP.DocEntry = @GRPODocEntry\n\t\t\tAND O.Docentry = @SODocEntry\n\t\t\tAND O.TypeGD = 1\n\t\t\tAND P.Price <> O.OpenStockPrice\n\n\t\tSELECT\n\t\t\t  R.DocEntry\n\t\t\t, R.ItemCode\n\t\t\t, R.Dscription\n\t\t\t, R.U_WhsCod\n\t\t\t, R.U_IMei\n\t\t\t, R.Quantity\n\t\t\t, R.U_Price\n\t\t\t, '----------'\n\t\t\t, O.Docentry\n\t\t\t, O.ItemCode\n\t\t\t, O.EMEI\n\t\t\t, O.Whscode\n\t\t\t, O.Quantity\n\t\t\t, O.OpenStockPrice\n\t\tFROM\n\t\t\tdbo.RDR1 R (NOLOCK)\n\t\t\t\tINNER JOIN dbo.FRT_POS_OIVL O (NOLOCK)\n\t\t\t\t\tON R.U_IMei = O.EMEI\n\t\tWHERE\n\t\t\tR.DocEntry = @SODocEntry\n\t\t\tAND O.Docentry = @SODocEntry\n\t\t\tAND O.TypeGD = 1\n\t\t\tAND R.U_Price <> O.OpenStockPrice\n\tEND\n"
}