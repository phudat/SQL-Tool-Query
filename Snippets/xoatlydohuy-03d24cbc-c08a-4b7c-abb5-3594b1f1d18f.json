{
  "id": "03d24cbc-c08a-4b7c-abb5-3594b1f1d18f",
  "prefix": "xoatlydohuy",
  "description": "Xóa lý do hủy Ecom",
  "body": "DECLARE \n\t  @SO INT = $CURSOR$\n\t, @CallLogID INT\n\t, @CallLogStatus TINYINT\n\nSELECT @CallLogID = CallLogID FROM dbo.tbl_Lydohuy_SOEcom (NOLOCK) WHERE DocentrySO = @SO\nSELECT @CallLogStatus = R.Status FROM [10.1.13.73].FRTCallLogV2.dbo.Requests AS R (NOLOCK) WHERE R.Id = @callLogID\nSELECT @CallLogID, @CallLogStatus\nSELECT N'Trước khi xóa', * FROM tbl_Lydohuy_SOEcom (NOLOCK) WHERE DocentrySO = @SO\nIF ISNULL(@CallLogStatus, 0) = 0\n\tBEGIN\n\t    SELECT N'Không có số Call Log.'\n\tEND\nELSE IF @CallLogStatus = 4\n\tBEGIN\n\t    SELECT N'Call Log' + CONVERT(VARCHAR, @CallLogID) + N' hoàn tất rồi.'\n\tEND\nELSE IF @CallLogStatus = 1\n\tBEGIN\n\t    SELECT N'Call Log' + CONVERT(VARCHAR, @CallLogID) + N' vẫn còn chờ xử lý.'\n\tEND\nELSE IF @CallLogStatus = 5\n\tBEGIN\n\t    INSERT  INTO dbo.tbl_Lydohuy_SOEcom_DEL\n\t\t\t(\n\t\t\t\t DocentrySO\n\t\t\t   , Reason\n\t\t\t   , CreateDate\n\t\t\t   , CreateBy\n\t\t\t   , NumEcom\n\t\t\t   , DocStatus\n\t\t\t   , DocType\n\t\t\t   , PickStatus\n\t\t\t   , CallLogID\n\t\t\t   , Remark\n\t\t\t   , DeletedDateTime\n\t\t\t)\n\t\tSELECT\n\t\t\t  DocentrySO\n\t\t\t, Reason\n\t\t\t, CreateDate\n\t\t\t, CreateBy\n\t\t\t, NumEcom\n\t\t\t, DocStatus\n\t\t\t, DocType\n\t\t\t, PickStatus\n\t\t\t, CallLogID\n\t\t\t, CONVERT(VARCHAR, @CallLogID) + N' đã hủy.'\n\t\t\t, GETDATE()\n\t\tFROM\n\t\t\tdbo.tbl_Lydohuy_SOEcom (NOLOCK)\n\t\tWHERE\n\t\t\tDocentrySO = @SO; \n\n\t\tDELETE FROM\n\t\t\tdbo.tbl_Lydohuy_SOEcom\n\t\tWHERE\n\t\t\tDocentrySO = @SO; \n\n\t\tUPDATE\n\t\t\tFRT_POS.dbo.ORDR\n\t\tSET\n\t\t\tCallog_ID = NULL\n\t\tWHERE\n\t\t\tDocEntry = @SO; \n\tEND\nELSE\n\tBEGIN\n\t    SELECT @CallLogID CallLogID, @CallLogStatus CallLogStatus\n\tEND\nSELECT N'[DEL]', * FROM dbo.tbl_Lydohuy_SOEcom_DEL (NOLOCK) WHERE DocentrySO = @SO\nSELECT N'Sau khi xóa', * FROM tbl_Lydohuy_SOEcom (NOLOCK) WHERE DocentrySO = @SO"
}