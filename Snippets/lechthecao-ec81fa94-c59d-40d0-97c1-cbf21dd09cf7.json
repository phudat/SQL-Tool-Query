{
  "id": "ec81fa94-c59d-40d0-97c1-cbf21dd09cf7",
  "prefix": "lechthecao",
  "description": "Check lệch tiền thẻ cào",
  "body": "DECLARE \n\t  @WarehouseCode \tVARCHAR(40) = '$CURSOR$'\n\t, @Date \t\t\tDATE \t\t= ''\n\nSELECT\n      S.ID\n\t, S.SalesOrderCode\n\t, S.TotalReferAmount\nINTO\n\t#tmpSale\nFROM\n    [10.1.13.76].FRTCRM.dbo.SalesOrders S WITH (NOLOCK)\n\t\tLEFT JOIN [10.1.13.76].FRTCRM.dbo.POSPaymentMethod P (NOLOCK)\n\t\t\tON S.ID = P.SalesOrdersID\nWHERE\n    S.WarehouseCode = @WarehouseCode\n    AND CONVERT(DATE, S.SalesOrderDate) = @Date\n\tAND S.SalesOrdersStatus = 67\n\tAND ISNULL(S.POSIsPushed, 0) = 0\n\nSELECT\n      T.ID\n\t, T.SalesOrderCode\n\t, T.TotalReferAmount\n\t, ISNULL(P.CashAmount, 0)\t\tAS CashAmount\n\t, ISNULL(P.CardAmount, 0)\t\tAS CardAmount\n\t, ISNULL(P.VoucherAmount, 0)\tAS VoucherAmount\n\t, ISNULL(P.TransferAmount, 0)\tAS TransferAmount\nINTO\n\t#tmpPayment\nFROM\n    #tmpSale T\n\t\tLEFT JOIN [10.1.13.76].FRTCRM.dbo.POSPaymentMethod P (NOLOCK)\n\t\t\tON T.ID = P.SalesOrdersID\n\nSELECT\n    T.SalesOrderCode\n  , T.TotalReferAmount\n  , SUM(T.CashAmount + T.CardAmount + T.VoucherAmount + T.TransferAmount) AS TotalPOSPaymentMethod\nFROM\n    #tmpPayment T\nGROUP BY\n    T.SalesOrderCode\n  , T.TotalReferAmount\nHAVING\n\tSUM(T.CashAmount + T.CardAmount + T.VoucherAmount + T.TransferAmount) <> TotalReferAmount\n\nDROP TABLE #tmpSale, #tmpPayment"
}