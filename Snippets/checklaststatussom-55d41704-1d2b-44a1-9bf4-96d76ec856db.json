{
  "id": "55d41704-1d2b-44a1-9bf4-96d76ec856db",
  "prefix": "checklaststatussom",
  "description": "kiem tra trang thai cuoi cac phieu som",
  "body": "EXEC dbo.SP_SOM_ToolGetInforByListBillNoSOM @listKeySearch = 'CREATE,PROCESSING,CANCEL_PROCESSING', -- varchar(max)\r\n                                            @size = 10000,           -- int\r\n                                            @type = 6  ,       -- int\r\n\t\t\t\t\t\t\t\t\t\t\t@FromDate ='$CURSOR$',\r\n\t\t\t\t\t\t\t\t\t\t\t@ToDate ='$CURSOR$'\r\nSELECT orderId,billNo,orderStatus,ifb.creationTime, ifb.providerId,ifb.productId,ppc.IntegratedGroupCode, PPC.IntegratedProductCode INTO #tmp_scan FROM dbo.InforByListBillNoSOM ifb WITH (NOLOCK) \r\nINNER JOIN dbo.ProductProviderConfig PPC WITH (nolock) ON ifb.providerId=PPC.ProviderId AND ifb.productId=ppc.ProductId\r\nUPDATE #tmp_scan SET IntegratedGroupCode='' WHERE ISNULL(IntegratedGroupCode,'')=''\r\nUPDATE #tmp_scan SET IntegratedProductCode='' WHERE ISNULL(IntegratedProductCode,'')=''\r\n\r\nCREATE TABLE #temptable ( [orderId] nvarchar(250), [status] nvarchar(250), [requestId] nvarchar(250), [returnedTransactionId] nvarchar(250), [errorCode] varchar(250), [errorMsg] nvarchar(250), [cancelAcceptedAmount] nvarchar(250) )\r\n\r\n\tDECLARE CUR_PO CURSOR \r\n\tFOR \r\n\t\tSELECT orderId,providerId,productId,IntegratedGroupCode,IntegratedProductCode FROM #tmp_scan WITH (NOLOCK)\r\n\tOPEN CUR_PO\t\t\r\n\tDECLARE @orderId VARCHAR(50),@providerId VARCHAR(50),@productId VARCHAR(50),@IntegratedGroupCode varchar(50),@IntegratedProductCode  VARCHAR(50)\r\n\tFETCH NEXT FROM CUR_PO INTO @orderId ,@providerId ,@productId ,@IntegratedGroupCode,@IntegratedProductCode\r\n\twhile ( @@FETCH_STATUS = 0)\r\n\tbegin\r\n\t\tDECLARE @responseText NVARCHAR(MAX);\r\n\t\tEXEC [dbo].[SP_SOM_ToolGetLastStatus_CallAPI] @OrderId = @orderId,                       -- varchar(50)\r\n                                              @ProviderId = @providerId,                    -- varchar(50)\r\n                                              @ProductId = @productId,                     -- varchar(50)\r\n                                              @IntegrationProductCode = @IntegratedGroupCode,        -- varchar(50)\r\n                                              @integratedGroupCode = @IntegratedProductCode,           -- varchar(50)\r\n                                              @URI = '',                           -- varchar(2000)\r\n                                              @requestBody = '',                   -- varchar(8000)\r\n                                              @SoapAction = '',                    -- varchar(255)\r\n                                              @UserName = N'Authentication',                     -- nvarchar(100)\r\n                                              @Password = N'Authentication',                     -- nvarchar(100)\r\n                                              @responseText = @responseText OUTPUT -- nvarchar(max)\r\n\t\tINSERT INTO #temptable ([orderId], [status], [requestId], [returnedTransactionId], [errorCode], [errorMsg], [cancelAcceptedAmount])\t\r\n\t\tSELECT @orderId,\r\n                js.status,\r\n                js.requestId,\r\n                js.returnedTransactionId,\r\n                js.errorCode,\r\n                js.errorMsg,\r\n                js.cancelAcceptedAmount\t\r\n\t\tFROM OPENJSON(@responseText)  \r\n\t\tWITH (\r\n\t\t\torderId NVARCHAR(250) '$.orderId',\r\n\t\t\tstatus NVARCHAR(250) '$.status',\t\t\r\n\t\t\trequestId NVARCHAR(250) '$.requestId',\r\n\t\t\treturnedTransactionId NVARCHAR(250) '$.returnedTransactionId',\r\n\t\t\terrorCode VARCHAR(250) '$.errorCode',\t\t\r\n\t\t\terrorMsg NVARCHAR(250) '$.errorMsg',\r\n\t\t\tcancelAcceptedAmount NVARCHAR(250) '$.cancelAcceptedAmount'\r\n\t\t) AS js\r\n\t\tFETCH NEXT FROM CUR_PO INTO @orderId ,@providerId ,@productId ,@IntegratedGroupCode,@IntegratedProductCode\r\n\tEND\r\n\tCLOSE CUR_PO\r\n\tDEALLOCATE CUR_PO\r\n\r\n\r\nSELECT t.orderId,s.providerId,s.productId,s.IntegratedGroupCode,s.IntegratedProductCode,s.billNo,s.creationTime,s.orderStatus status_current,\r\n       t.status status_Provider,t.requestId,t.returnedTransactionId,t.errorCode,t.errorMsg,\r\n       t.cancelAcceptedAmount FROM #temptable t WITH (NOLOCK) INNER JOIN #tmp_scan s ON t.orderId=s.orderId DROP TABLE #temptable,#tmp_scan"
}