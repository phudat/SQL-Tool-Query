{
  "id": "bf441392-43cc-4399-b809-24b222959fc9",
  "prefix": "loaikhosothuc",
  "description": "keo sim tu thuc ve beta va loai kho ",
  "body": "\tDECLARE @xmlupdateresult NVARCHAR(max)= N'0708374100,0932087573,0707780530'\n\tDECLARE @loaikho BIT =0\n\n\t--RETURN\n\t--tao bang tu chuoi so vua khai bao\n\tCREATE TABLE #temppull (id INT IDENTITY,phonepull VARCHAR(50))\n\tINSERT INTO #temppull\n\t(\n\t\tphonepull\n\t)\n\tSELECT REPLACE(REPLACE(LTRIM(RTRIM(VALUE)),CHAR(13),''),NCHAR(10),'') FROM dbo.ufn_StringToTable(@xmlupdateresult,',',0) \n\tDECLARE @totalrow INT\n\tSELECT @totalrow=COUNT(phonepull) FROM #temppull WITH (NOLOCK)\n\n\t--keo data tu tren thuc ve beta\n\tSELECT TOP (@totalrow)\t\n\t\tProductCodeInStock,\n\t    ProductName,\n\t    SimSource,\n\t    ActivedCode,\n\t    ProductID,\n\t    PhoneAdjusted,\n\t    PriceUsed,\n\t    Provider,\n\t    ExpiredDate,\n\t    ProductCodenNotInStock,\n\t    GoodsGroup,\n\t    PromotionDescriptionProvider,\n\t    ExpiredPromotionDateProvider,\n\t    PromotionDescriptionFRT,\n\t    ExpiredPromotionDateFRT,\n\t    PriceSale,\n\t    SimOnlineType,\n\t    CreatedDatetime,\n\t    CreatedEmployeeCode,\n\t    LastUpdatedDatetime,\n\t    LastUpdatedEmployeeCode,\n\t    Status,\n\t    IsActived,\n\t    SupportInfoNSX,\n\t    Simserial,\n\t    Remark,\n\t    SimCatalog,\n\t    SimType,\n\t    TypeOfSubscription,\n\t    ShopBook,\n\t    BookDate,\n\t    PriceCost,\n\t    PriorityComSale \t\t\n\tINTO #tempso\n\tFROM [10.96.254.98].FRTCRM_MDM.dbo.StoreOnline WITH (NOLOCK) \n\tWHERE Provider like '%Mobifone%' AND BookDate IS NULL and ShopBook IS NULL  and Status='I' AND IsActived= 1-- AND PhoneAdjusted='0877753139' -- neu keo theo so\n\n\t\n\n\tINSERT INTO [10.96.254.143].FRTCRM_Pro1.dbo.StoreOnline\n\t(\n\t    ProductCodeInStock,\n\t    ProductName,\n\t    SimSource,\n\t    ActivedCode,\n\t    ProductID,\n\t    PhoneAdjusted,\n\t    PriceUsed,\n\t    Provider,\n\t    ExpiredDate,\n\t    ProductCodenNotInStock,\n\t    GoodsGroup,\n\t    PromotionDescriptionProvider,\n\t    ExpiredPromotionDateProvider,\n\t    PromotionDescriptionFRT,\n\t    ExpiredPromotionDateFRT,\n\t    PriceSale,\n\t    SimOnlineType,\n\t    CreatedDatetime,\n\t    CreatedEmployeeCode,\n\t    LastUpdatedDatetime,\n\t    LastUpdatedEmployeeCode,\n\t    Status,\n\t    IsActived,\n\t    SupportInfoNSX,\n\t    Simserial,\n\t    Remark,\n\t    SimCatalog,\n\t    SimType,\n\t    TypeOfSubscription,\n\t    ShopBook,\n\t    BookDate,\n\t    PriceCost,\n\t    PriorityComSale\n\t)\n\tSELECT\t\n\t\tProductCodeInStock,\n\t    ProductName,\n\t    SimSource,\n\t    ActivedCode,\n\t    ProductID,\n\t    PhoneAdjusted,\n\t    PriceUsed,\n\t    Provider,\n\t    ExpiredDate,\n\t    ProductCodenNotInStock,\n\t    GoodsGroup,\n\t    PromotionDescriptionProvider,\n\t    ExpiredPromotionDateProvider,\n\t    PromotionDescriptionFRT,\n\t    ExpiredPromotionDateFRT,\n\t    PriceSale,\n\t    SimOnlineType,\n\t    CreatedDatetime,\n\t    CreatedEmployeeCode,\n\t    LastUpdatedDatetime,\n\t    LastUpdatedEmployeeCode,\n\t    Status,\n\t    IsActived,\n\t    SupportInfoNSX,\n\t    Simserial,\n\t    Remark,\n\t    SimCatalog,\n\t    SimType,\n\t    TypeOfSubscription,\n\t    ShopBook,\n\t    BookDate,\n\t    PriceCost,\n\t    PriorityComSale \n\t\tFROM #tempso\n\n\tINSERT INTO [10.96.254.143].FRTCRM_Pro1.dbo.CRM_SimType_Price\n\t(\n\t    SimTypeID,\n\t    SimTypeName,\n\t    PhoneNumber,\n\t    PriceSale,\n\t    CreateDate,\n\t    CreateBy,\n\t    UpdateDate,\n\t    UpdateBy,\n\t    InsureAmount\n\t)\n\tSELECT  \n\t\tSimTypeID,\n\t    SimTypeName,\n\t    PhoneNumber,\n\t    PriceSale,\n\t    CreateDate,\n\t    CreateBy,\n\t    UpdateDate,\n\t    UpdateBy,\n\t    InsureAmount \n\tFROM  \n\t\t[10.96.254.98].FRTCRM_MDM.dbo.CRM_SimType_Price WITH (NOLOCK) \n\tWHERE \n\t\tPhoneNumber IN (SELECT ProductID FROM #tempso)\t\t\n\n\t--loai kho neu can\n\tIF @loaikho=1\n\tBEGIN\n\t    UPDATE [10.96.254.98].FRTCRM_MDM.dbo.StoreOnline  SET IsActived=0,Status='E',Remark='Ho tro anh Gia '+ CAST(GETDATE() AS VARCHAR(20)) WHERE  PhoneAdjusted IN (SELECT PhoneAdjusted FROM #tempso WITH (NOLOCK))\n\tEND\n\n\t--tao bang tam chuan bi cho viec cap nhat ve dung so yeu cau\n\tCREATE TABLE #tempupdate(id INT IDENTITY, phoneadj VARCHAR(50),phone VARCHAR(50))\n\tINSERT INTO #tempupdate\n\t(\n\t    phoneadj,\n\t    phone\n\t)\t\n\tSELECT PhoneAdjusted,'' FROM #tempso WITH (NOLOCK)\n\tIF (SELECT COUNT(id) FROM #tempupdate WITH (NOLOCK) ) = @totalrow\n\tBEGIN\n\t\tDECLARE @cnt INT = 1;\n\t\tDECLARE @phonetopull VARCHAR(50)\n\t\tSET @phonetopull = (SELECT phonepull FROM #temppull WITH (NOLOCK) WHERE id = @cnt)\n\t\tWHILE @cnt <=  (SELECT COUNT(id) FROM #tempupdate WITH (NOLOCK) )\n\t\tBEGIN\n\t\t\tUPDATE #tempupdate SET phone=@phonetopull WHERE id =@cnt\n\t\t\tSET @cnt = @cnt + 1;\n\t\tEND;\t\t\n\tEND\n\n\t--bat dau update\n\tDECLARE CUR_PO CURSOR \n\tFOR \t\n\t\tSELECT phoneadj,phone FROM #tempupdate WITH (NOLOCK) \n\t\n\tOPEN CUR_PO\t\t\n\tDECLARE @PhoneAdjusted VARCHAR(50),@Phone VARCHAR(50)\n\tFETCH NEXT FROM CUR_PO INTO @PhoneAdjusted,@Phone\n\twhile ( @@FETCH_STATUS = 0)\n\tbegin\n\t\tUPDATE [10.96.254.143].FRTCRM_Pro1.dbo.StoreOnline SET PhoneAdjusted=@phone, ProductID= @Phone WHERE PhoneAdjusted=@PhoneAdjusted\n\t\tUPDATE [10.96.254.143].FRTCRM_Pro1.dbo.CRM_SimType_Price SET PhoneNumber=@Phone WHERE PhoneNumber= @PhoneAdjusted\n\t\tFETCH NEXT FROM CUR_PO INTO @PhoneAdjusted,@Phone\n\tEND\n\tCLOSE CUR_PO\n\tDEALLOCATE CUR_PO\n\tSELECT * FROM [10.96.254.143].FRTCRM_Pro1.dbo.StoreOnline WHERE ProductID IN (SELECT phone FROM #tempupdate)\n\tDROP TABLE #tempso, #temppull,#tempupdate"
}