{
  "id": "b140cef9-27c9-4aa7-84aa-0cf99dd8dbd3",
  "prefix": "buildthutienvnp",
  "description": "Build lại thu tiền VNPay",
  "body": "DECLARE @docEntry INT = $CURSOR$; \n\nSELECT\n    *\nINTO\n\t#tmpQRPay\nFROM\n    dbo.QRCode_Payment_Push AS Q (NOLOCK)\nWHERE\n    Q.DocEntry = @docEntry\n    AND Q.U_type = 'P'\n    AND Q.U_status = '4';\n\nDECLARE\n        @CardCodeQRPay INT\n      , @EplCodeQRPay INT\n      , @QRDocStatus CHAR(1)\n      , @QRShopCode VARCHAR(20)\n      , @QRAccCash NVARCHAR(50);\nSELECT\n\t  @CardCodeQRPay = CardCode\n\t, @EplCodeQRPay = CreateBy\n\t, @QRDocStatus = DocStatus\n\t, @QRShopCode = U_ShpCod\nFROM\n    dbo.ORDR (NOLOCK)\nWHERE\n    DocEntry = @docEntry;\nSELECT TOP 1\n    @QRAccCash = F.U_AccCash\nFROM\n    FRT_MDM.dbo.[@FPTSHOP] F WITH (NOLOCK)\nWHERE\n    F.Code = @QRShopCode;\n\nDELETE FROM\n    dbo.[@FPTORCT]\nWHERE\n    U_DocSO = @docEntry\n    AND IsAutoCard = 'Y'\n    AND U_Acbank = '6'\n    AND ISNULL(U_DocDown, 0) = 0;\n-- Check trên thực bảng: FRT_MDM.dbo.OCRP - Ví điện tử\nINSERT  INTO [@FPTORCT]\n        (\n         CardType\n       , U_CName\n       , U_Acbank\n       , U_CTLKCode\n       , U_CTLKName\n       , U_MoCash\n       , U_MoCCad\n       , U_CrDate\n       , U_AccNum\n       , U_AccName\n       , U_BankTs\n       , U_MoTran\n       , U_DateTs\n       , U_NumVch\n       , U_NaVoch\n       , U_MoVoCh\n       , U_EDate\n       , U_DocSO\n       , U_DocDown\n       , U_ShpCod\n       , U_AcCash\n       , U_TypCre\n       , U_Acount\n       , U_NumCre\n       , U_AcVoch\n       , U_Status\n       , U_CrdCod\n       , U_AcDate\n       , U_EplCod\n       , CreateDate\n       , U_Desc\n       , IS_VC_CRM\n       , U_loaiCT\n       , U_DocAR\n       , IsAutoCard\n\t\t\t\t\t\t\t\n        )\nSELECT\n    '6'\t\t\t\t\t--VNPay: FRT_MDM.dbo.OCRC\n  , '6'\t\t\t\t\t--VNPay: FRT_MDM.dbo.OCRC\n  , '6'\t\t\t\t\t--Ví điện tử FRT_MDM.dbo.OCRP\n  , N'Ví điện tử'\n  , ''\n  , 0\n  , C.Tmonbi\n  , C.createdate\n  , ''\n  , ''\n  , ''\n  , 0\n  , C.createdate\n  , ''\n  , ''\n  , 0\n  , C.createdate\n  , @docEntry\n  , NULL\n  , @QRShopCode\n  , @QRAccCash\n  , '6'\t\t\t\t\t--VNPay: FRT_MDM.dbo.OCRC\n  , '113100100'\n  , ISNULL(C.TransactionNum_VNPay, '')\n  , ''\n  , 1\n  , @CardCodeQRPay\n  , C.createdate\n  , C.createby\n  , C.createdate\n  , 'THU SO QRPay'\n  , 1\n  , NULL\n  , 0\n  , 'Y'\nFROM\n    #tmpQRPay C;\n\nDROP TABLE #tmpQRPay"
}